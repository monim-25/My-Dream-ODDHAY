<!DOCTYPE html>
<html class="light" lang="bn">

<head>
    <title>রেজিস্ট্রেশন | অধ্যায়</title>
    <%- include('partials/head') %>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen flex items-center justify-center p-6 relative">
    <!-- Decorative Blobs -->
    <div class="bg-blob -top-20 -left-20 opacity-50"></div>
    <div class="bg-blob -bottom-20 -right-20 opacity-40" style="animation-delay: -5s;"></div>

    <div class="max-w-2xl w-full relative z-10">
        <!-- Progress Stepper -->
        <div class="mb-10 px-10">
            <div class="flex justify-between items-center relative">
                <div
                    class="absolute h-1 w-full bg-slate-200 dark:bg-slate-800 top-1/2 -translate-y-1/2 z-0 rounded-full">
                </div>
                <div id="progress-bar"
                    class="absolute h-1 w-0 bg-primary top-1/2 -translate-y-1/2 z-0 rounded-full transition-all duration-500">
                </div>

                <div
                    class="step-icon active z-10 size-10 rounded-full bg-white dark:bg-slate-900 border-4 border-primary flex items-center justify-center font-black text-sm">
                    1</div>
                <div
                    class="step-icon z-10 size-10 rounded-full bg-white dark:bg-slate-900 border-4 border-slate-200 dark:border-slate-800 flex items-center justify-center font-black text-sm transition-colors duration-500">
                    2</div>
                <div
                    class="step-icon z-10 size-10 rounded-full bg-white dark:bg-slate-900 border-4 border-slate-200 dark:border-slate-800 flex items-center justify-center font-black text-sm transition-colors duration-500">
                    3</div>
            </div>
        </div>

        <div class="glass-card shadow-2xl reveal active p-10 md:p-14 mb-10 overflow-hidden"
            style="border-radius: 3.5rem;">
            <div class="text-center mb-12">
                <a href="/" class="inline-flex items-center gap-2 mb-6 group">
                    <div class="text-primary group-hover:rotate-12 transition-transform duration-300">
                        <svg class="size-10" fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4H17.3334V17.3334H30.6666V30.6666H44V44H4V4Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <span class="text-2xl font-black tracking-tighter">অধ্যায়</span>
                </a>
                <h1 id="step-title" class="h2-section !text-3xl mb-2">আপনার পরিচয় দিন</h1>
                <p id="step-desc" class="text-slate-500 font-bold text-sm">প্রাথমিক তথ্য দিয়ে শুরু করুন</p>
            </div>

            <form id="register-form" class="space-y-8 min-h-[300px] flex flex-col justify-between">
                <!-- Step 1: Personal Info -->
                <div id="step-1" class="step-content space-y-6">
                    <div class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">পুরো
                            নাম</label>
                        <input type="text" name="name" placeholder="আপনার নাম লিখুন"
                            class="w-full px-6 h-15 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-slate-900 transition-all font-bold text-base shadow-inner placeholder:text-slate-400 dark:placeholder:text-slate-600"
                            required>
                    </div>
                    <div class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">ইমেইল
                            অথবা ফোন</label>
                        <input type="text" name="identifier" placeholder="নাম্বার বা ইমেইল লিখুন"
                            class="w-full px-6 h-15 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-slate-900 transition-all font-bold text-base shadow-inner placeholder:text-slate-400 dark:placeholder:text-slate-600"
                            required>
                    </div>
                </div>

                <!-- Step 2: Role & Class -->
                <div id="step-2" class="step-content hidden space-y-6">
                    <div class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">আপনি
                            একজন</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" name="role" value="student" class="hidden peer" checked>
                                <div
                                    class="p-4 text-center rounded-2xl border-2 border-slate-100 dark:border-slate-800 peer-checked:border-primary peer-checked:bg-primary/5 font-black text-sm transition-all">
                                    শিক্ষার্থী</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="role" value="parent" class="hidden peer">
                                <div
                                    class="p-4 text-center rounded-2xl border-2 border-slate-100 dark:border-slate-800 peer-checked:border-primary peer-checked:bg-primary/5 font-black text-sm transition-all">
                                    অভিভাবক</div>
                            </label>
                        </div>
                    </div>
                    <div id="class-group" class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">শ্রেণী
                            / স্তর</label>
                        <select name="classLevel"
                            class="w-full px-6 h-15 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-slate-900 transition-all font-bold text-base shadow-inner appearance-none cursor-pointer">
                            <% ['Class 6', 'Class 7' , 'Class 8' , 'Class 9' , 'Class 10' , 'Class 11' , 'Class 12'
                                , 'HSC' ].forEach(cls=> { %>
                                <option value="<%= cls %>">
                                    <%= cls %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Security -->
                <div id="step-3" class="step-content hidden space-y-6">
                    <div class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">পাসওয়ার্ড</label>
                        <input type="password" name="password" placeholder="••••••••"
                            class="w-full px-6 h-15 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-slate-900 transition-all font-bold text-base shadow-inner"
                            required>
                    </div>
                    <div class="group">
                        <label
                            class="block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2">পুনরায়
                            লিখুন</label>
                        <input type="password" name="confirmPassword" placeholder="••••••••"
                            class="w-full px-6 h-15 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-slate-900 transition-all font-bold text-base shadow-inner"
                            required>
                    </div>
                </div>

                <div class="flex gap-4 pt-10">
                    <button type="button" id="prev-btn"
                        class="hidden flex-1 h-16 rounded-[1.5rem] bg-slate-100 dark:bg-slate-800 text-slate-500 font-extrabold hover:bg-slate-200 dark:hover:bg-slate-700 transition-all duration-300 flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-2xl">west</span> পিছনে
                    </button>
                    <button type="button" id="next-btn"
                        class="flex-[2] h-16 rounded-[1.5rem] bg-primary text-white font-extrabold shadow-xl shadow-primary/30 hover:shadow-primary/50 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2 group">
                        <span id="btn-text" class="text-lg">পরবর্তী</span>
                        <span
                            class="material-symbols-outlined text-2xl group-hover:translate-x-1 transition-transform">east</span>
                    </button>
                    <button type="submit" id="submit-btn"
                        class="hidden flex-[2] h-16 rounded-[1.5rem] bg-primary text-white font-extrabold shadow-xl shadow-primary/30 hover:shadow-primary/50 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2 group">
                        <span id="finish-text" class="text-lg">রেজিস্ট্রেশন করুন</span>
                        <span
                            class="material-symbols-outlined text-2xl group-hover:scale-110 transition-transform">task_alt</span>
                    </button>
                </div>
            </form>
        </div>

        <div class="text-center">
            <p class="body-main !text-sm text-slate-500 font-bold flex items-center justify-center gap-2">
                ইতিমধ্যে একাউন্ট আছে? <a href="/login" class="text-primary hover:underline font-black">লগইন করুন <span
                        class="material-symbols-outlined !text-sm align-middle">login</span></a>
            </p>
        </div>
    </div>

    <!-- Custom Toast -->
    <div id="toast"
        class="fixed top-10 right-1/2 translate-x-1/2 z-[100] scale-0 transition-transform duration-300 pointer-events-none">
        <div id="toast-body"
            class="px-8 py-4 rounded-full bg-red-500 text-white font-black shadow-2xl flex items-center gap-3">
            <span id="toast-icon" class="material-symbols-outlined">error</span>
            <span id="toast-msg">ত্রুটি দেখা দিয়েছে</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let currentStep = 1;
            const form = document.getElementById('register-form');
            const steps = document.querySelectorAll('.step-content');
            const icons = document.querySelectorAll('.step-icon');
            const bar = document.getElementById('progress-bar');

            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const submitBtn = document.getElementById('submit-btn');

            const stepTitles = [
                'আপনার পরিচয় দিন',
                'আপনার অবস্থান জানান',
                'নিরাপত্তা নিশ্চিত করুন'
            ];
            const stepDescs = [
                'প্রাথমিক তথ্য দিয়ে শুরু করুন',
                'আপনি শিক্ষার্থী নাকি অভিভাবক?',
                'একটি শক্তিশালী পাসওয়ার্ড দিন'
            ];

            function showToast(msg, type = 'error') {
                const toast = document.getElementById('toast');
                const body = document.getElementById('toast-body');
                const icon = document.getElementById('toast-icon');
                const message = document.getElementById('toast-msg');

                body.className = `px-8 py-4 rounded-full font-black shadow-2xl flex items-center gap-3 ${type === 'success' ? 'bg-emerald-500' : 'bg-red-500'} text-white`;
                icon.textContent = type === 'success' ? 'check_circle' : 'error';
                message.textContent = msg;

                toast.classList.remove('scale-0');
                toast.classList.add('scale-100');

                setTimeout(() => {
                    toast.classList.remove('scale-100');
                    toast.classList.add('scale-0');
                }, 4000);
            }

            function updateStep() {
                steps.forEach((s, idx) => s.classList.toggle('hidden', idx !== currentStep - 1));
                icons.forEach((ic, idx) => {
                    if (idx < currentStep) {
                        ic.classList.add('border-primary', 'bg-primary', 'text-white');
                        ic.classList.remove('border-slate-200', 'dark:border-slate-800');
                    } else {
                        ic.classList.remove('border-primary', 'bg-primary', 'text-white');
                        ic.classList.add('border-slate-200', 'dark:border-slate-800');
                    }
                });

                bar.style.width = `${((currentStep - 1) / 2) * 100}%`;

                document.getElementById('step-title').textContent = stepTitles[currentStep - 1];
                document.getElementById('step-desc').textContent = stepDescs[currentStep - 1];

                prevBtn.classList.toggle('hidden', currentStep === 1);
                nextBtn.classList.toggle('hidden', currentStep === 3);
                submitBtn.classList.toggle('hidden', currentStep !== 3);
            }

            nextBtn.onclick = () => {
                const stepInputs = steps[currentStep - 1].querySelectorAll('input, select');
                let valid = true;
                stepInputs.forEach(input => {
                    if (input.hasAttribute('required') && !input.value.trim()) {
                        valid = false;
                        input.classList.add('!border-red-500');
                    } else {
                        input.classList.remove('!border-red-500');
                    }
                });

                if (valid) {
                    currentStep++;
                    updateStep();
                } else {
                    showToast('দয়া করে সব তথ্য পূরণ করুন');
                }
            };

            prevBtn.onclick = () => {
                currentStep--;
                updateStep();
            };

            const roleInputs = document.querySelectorAll('input[name="role"]');
            roleInputs.forEach(input => {
                input.onchange = () => {
                    document.getElementById('class-group').classList.toggle('hidden', input.value === 'parent');
                };
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                const formData = Object.fromEntries(new FormData(form));

                if (formData.password !== formData.confirmPassword) {
                    return showToast('পাসওয়ার্ড দুটি মিলছে না');
                }

                // Loading State
                const finishText = document.getElementById('finish-text');
                const origText = finishText.textContent;
                finishText.textContent = 'প্রসেসিং হচ্ছে...';
                submitBtn.disabled = true;

                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#137fec', '#ffffff'] });
                        showToast('নিবন্ধন সফল হয়েছে! ড্যাশবোর্ডে নিয়ে যাওয়া হচ্ছে...', 'success');
                        setTimeout(() => window.location.href = result.redirect, 2000);
                    } else {
                        showToast(result.error || 'নিবন্ধন ব্যর্থ হয়েছে');
                        finishText.textContent = origText;
                        submitBtn.disabled = false;
                    }
                } catch (err) {
                    showToast('সার্ভারে সমস্যা হয়েছে, আবার চেষ্টা করুন');
                    finishText.textContent = origText;
                    submitBtn.disabled = false;
                }
            };
        });
    </script>
</body>

</html>