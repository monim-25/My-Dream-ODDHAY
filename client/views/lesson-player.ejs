<!DOCTYPE html>
<html class="light" lang="bn">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>
        <%= course.title %> | ODDHAY
    </title>
    <%- include('partials/head') %>
        <style>
            .video-container {
                aspect-ratio: 16/9;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }

            .sidebar-scroll {
                height: calc(100vh - 250px);
            }

            .lesson-active {
                background: var(--primary) !important;
                color: white !important;
            }

            .lesson-active .status-icon,
            .lesson-active .time-icon,
            .lesson-active p,
            .lesson-active span {
                color: white !important;
            }
        </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen">
    <!-- Navbar -->
    <header class="glass-nav sticky top-0 z-[100] border-b border-slate-100 dark:border-slate-800">
        <div class="max-w-[1800px] mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <a href="/dashboard"
                    class="size-12 rounded-2xl bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-primary transition-all shadow-sm border border-slate-100 dark:border-slate-700">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <div class="reveal">
                    <h1 class="text-lg font-black truncate max-w-[200px] md:max-w-md leading-tight">
                        <%= course.title %>
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-black text-primary uppercase tracking-widest">
                            <%= course.subject %>
                        </span>
                        <span class="text-slate-300">•</span>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <%= course.classLevel %>
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4 reveal">
                <button
                    class="size-12 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-center text-slate-500 hover:text-primary transition-all"
                    onclick="document.documentElement.classList.toggle('dark')">
                    <span class="material-symbols-outlined block dark:hidden">dark_mode</span>
                    <span class="material-symbols-outlined hidden dark:block text-amber-400">light_mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1800px] mx-auto p-4 md:p-8">
        <div class="flex flex-col xl:flex-row gap-8">
            <!-- Left Side: Video Player & Content -->
            <div class="flex-1 space-y-8">
                <!-- Video Player Card -->
                <div class="bg-black rounded-[2.5rem] overflow-hidden video-container relative group reveal">
                    <% if (hasAccess) { %>
                        <iframe id="main-player" class="w-full h-full"
                            src="<%= course.lessons.length > 0 ? course.lessons[0].videoUrl : '' %>" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        <% if(course.lessons.length===0) { %>
                            <div
                                class="absolute inset-0 flex flex-col items-center justify-center text-white bg-slate-900 px-6 text-center">
                                <div class="size-20 rounded-full bg-white/10 flex items-center justify-center mb-6">
                                    <span class="material-symbols-outlined text-4xl">video_off</span>
                                </div>
                                <h3 class="text-xl font-black mb-2">কন্টেন্ট লোড করা যায়নি</h3>
                                <p class="text-slate-400 font-bold text-sm">এই লেসনটির ভিডিও সম্ভবত এখনো আপলোড করা হয়নি।
                                </p>
                            </div>
                            <% } %>
                                <% } else { %>
                                    <!-- Lock Overlay -->
                                    <div
                                        class="absolute inset-0 z-10 flex items-center justify-center p-8 text-center bg-slate-900/40 backdrop-blur-2xl">
                                        <div class="max-w-md w-full glass-card p-10 reveal active">
                                            <div
                                                class="size-20 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-8">
                                                <span
                                                    class="material-symbols-outlined text-4xl text-primary font-black">
                                                    <%= trialExpired ? 'hourglass_disabled' : (subscriptionExpired
                                                        ? 'history' : 'lock_open' ) %>
                                                </span>
                                            </div>
                                            <h3 class="text-2xl font-black mb-4 leading-tight">
                                                <%= trialExpired ? 'ফ্রি ট্রায়াল শেষ হয়েছে' : (subscriptionExpired
                                                    ? 'সাবস্ক্রিপশন শেষ' : 'এই লেসনটি লক করা আছে' ) %>
                                            </h3>
                                            <p class="text-slate-500 font-bold text-sm mb-10 leading-relaxed">
                                                <%= trialExpired
                                                    ? 'আপনার ট্রায়াল পিরিয়ড শেষ। নিয়মিত পড়াশোনা চালিয়ে যেতে এখনই এনরোল করুন।'
                                                    : (subscriptionExpired
                                                    ? 'আপনার সাবস্ক্রিপশন শেষ। নতুন প্ল্যান কিনে এক্সেস ফিরিয়ে নিন।'
                                                    : 'পুরো চ্যাপ্টারটি দেখতে এবং কন্টেন্ট আনলক করতে কোর্সটি কিনুন।' )
                                                    %>
                                            </p>

                                            <div class="space-y-4">
                                                <a href="/checkout/<%= course._id %>"
                                                    class="btn-primary w-full !rounded-2xl h-14">এনরোল করুন</a>
                                                <% if (course.accessType==='trial' && !trialExpired &&
                                                    !subscriptionExpired) { %>
                                                    <form action="/enroll-trial/<%= course._id %>" method="POST">
                                                        <button type="submit"
                                                            class="btn-secondary w-full !rounded-2xl h-14">ফ্রি ট্রায়াল
                                                            শুরু করুন</button>
                                                    </form>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <img src="<%= course.thumbnail || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&q=80&w=800' %>"
                                        class="w-full h-full object-cover blur-sm opacity-50">
                                    <% } %>
                </div>

                <!-- Content Info -->
                <div class="card-smart reveal">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                        <div>
                            <h2 id="current-lesson-title" class="text-2xl md:text-3xl font-black mb-2">
                                <%= course.lessons.length> 0 ? course.lessons[0].title : 'স্বাগতম' %>
                            </h2>
                            <p class="text-slate-500 font-bold text-sm">এই লেসনটিতে আপনি শিখবেন বিষয়ের মূল কনসেপ্টসমূহ।
                            </p>
                        </div>
                        <button id="complete-btn" onclick="markComplete()"
                            class="btn-primary !py-3 !px-8 !rounded-2xl shadow-emerald-500/20 shadow-xl overflow-visible">
                            <span class="material-symbols-outlined">verified</span> শেষ হয়েছে
                        </button>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-10 border-t border-slate-100 dark:border-slate-800">
                        <div>
                            <h3 class="font-black text-lg mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">analytics</span> কি কি শিখবেন?
                            </h3>
                            <ul class="space-y-3">
                                <% ['বিষয়ের গভীর বিশ্লেষণ', 'বাস্তব উদাহরণ' , 'বোর্ড পরীক্ষার প্রশ্ন সমাধান'
                                    , 'শর্টকাট টেকনিকসমূহ' ].forEach(item=> { %>
                                    <li class="flex items-center gap-3 text-sm font-bold text-slate-500 italic">
                                        <span
                                            class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                                        <%= item %>
                                    </li>
                                    <% }) %>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-black text-lg mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">download</span> ডাউনলোড রিসোর্স
                            </h3>
                            <div class="space-y-3">
                                <% if (course.notes && course.notes.length> 0) { %>
                                    <% course.notes.forEach(note=> { %>
                                        <div
                                            class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800 group hover:border-primary transition-colors">
                                            <div class="flex items-center gap-3">
                                                <div
                                                    class="size-10 rounded-xl bg-red-100 dark:bg-red-500/10 flex items-center justify-center text-red-500">
                                                    <span class="material-symbols-outlined">picture_as_pdf</span>
                                                </div>
                                                <span class="text-xs font-black truncate max-w-[150px]">
                                                    <%= note.title %>
                                                </span>
                                            </div>
                                            <a href="<%= note.fileUrl %>" target="_blank"
                                                class="size-10 rounded-xl bg-white dark:bg-slate-700 shadow-sm border border-slate-100 dark:border-slate-600 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-all">
                                                <span class="material-symbols-outlined text-xl">download</span>
                                            </a>
                                        </div>
                                        <% }) %>
                                            <% } else { %>
                                                <div
                                                    class="p-6 text-center border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-3xl">
                                                    <p class="text-xs font-bold text-slate-400">এই লেসনের জন্য কোনো
                                                        পিডিএফ নেই।</p>
                                                </div>
                                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Lesson Sidebar -->
            <aside class="w-full xl:w-[450px] shrink-0 reveal delay-200">
                <div
                    class="card-smart !p-0 sticky top-28 overflow-hidden flex flex-col h-full border-2 border-primary/10">
                    <div
                        class="p-10 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/20">
                        <h3 class="text-xl font-black mb-1">কোর্স কন্টেন্ট</h3>
                        <p class="text-slate-500 font-bold text-xs">
                            <%= course.lessons.length %> টি লেসন অন্তর্ভুক্ত
                        </p>

                        <!-- Mini Progress -->
                        <div class="mt-6">
                            <div class="flex justify-between items-end mb-2">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">আপনার
                                    প্রোগ্রেস</p>
                                <p class="text-xs font-black text-primary">০%</p>
                            </div>
                            <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-primary rounded-full transition-all duration-1000"
                                    style="width: 2%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-scroll overflow-y-auto p-4 custom-scrollbar">
                        <% if (user) { %>
                            <% course.lessons.forEach((lesson, index)=> { %>
                                <% const isCompleted=user.completedLessons &&
                                    user.completedLessons.includes(lesson._id.toString()); %>
                                    <button id="lesson-btn-<%= lesson._id %>" data-completed="<%= isCompleted %>"
                                        onclick="changeVideo('<%= lesson.videoUrl %>', '<%= lesson.title %>', '<%= lesson._id %>')"
                                        class="w-full flex items-center gap-4 p-5 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left mb-2 group <%= index === 0 ? 'bg-primary/5 border border-primary/20 outline outline-1 outline-primary/20' : '' %>">
                                        <div
                                            class="size-10 rounded-xl bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 flex items-center justify-center text-xs font-black shrink-0 text-slate-400 group-hover:scale-110 transition-transform">
                                            <span
                                                class="status-icon <%= isCompleted ? 'material-symbols-outlined text-emerald-500' : '' %>">
                                                <%= isCompleted ? 'check_circle' : (index + 1) %>
                                            </span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p
                                                class="text-sm font-black truncate leading-tight mb-1 group-hover:text-primary transition-colors">
                                                <%= lesson.title %>
                                            </p>
                                            <div
                                                class="flex items-center gap-3 text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                                <span class="flex items-center gap-1"><span
                                                        class="material-symbols-outlined text-[12px] time-icon">schedule</span>
                                                    <%= lesson.duration || '১০:০০' %>
                                                </span>
                                                <span>•</span>
                                                <span>রেকর্ড ক্লাস</span>
                                            </div>
                                        </div>
                                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                            <span class="material-symbols-outlined text-primary">play_circle</span>
                                        </div>
                                    </button>
                                    <% }); %>
                                        <% } %>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script>
        let currentLessonId = '<%= course.lessons.length > 0 ? course.lessons[0]._id : "" %>';

        function changeVideo(url, title, id) {
            document.getElementById('main-player').src = url;
            document.getElementById('current-lesson-title').innerText = title;
            currentLessonId = id;

            const btn = document.getElementById('complete-btn');
            const lessonBtn = document.getElementById(`lesson-btn-${id}`);
            const isCompleted = lessonBtn.getAttribute('data-completed') === 'true';

            if (isCompleted) {
                btn.className = "btn-secondary !py-3 !px-8 !rounded-2xl !bg-emerald-500/10 !text-emerald-500 pointer-events-none";
                btn.innerHTML = '<span class="material-symbols-outlined">task_alt</span> সম্পন্ন হয়েছে';
            } else {
                btn.className = "btn-primary !py-3 !px-8 !rounded-2xl shadow-emerald-500/20 shadow-xl overflow-visible";
                btn.innerHTML = '<span class="material-symbols-outlined">verified</span> শেষ হয়েছে';
                btn.style.pointerEvents = 'auto';
            }

            // Highlight active button
            document.querySelectorAll('button[id^="lesson-btn-"]').forEach(b => {
                b.classList.remove('bg-primary/5', 'border', 'border-primary/20', 'outline', 'outline-1', 'outline-primary/20');
                b.classList.remove('lesson-active');
            });
            lessonBtn.classList.add('bg-primary/5', 'border', 'border-primary/20', 'outline', 'outline-1', 'outline-primary/20');
        }

        async function markComplete() {
            const btn = document.getElementById('complete-btn');
            try {
                const res = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lessonId: currentLessonId })
                });

                if (res.ok) {
                    btn.className = "btn-secondary !py-3 !px-8 !rounded-2xl !bg-emerald-500/10 !text-emerald-500 pointer-events-none";
                    btn.innerHTML = '<span class="material-symbols-outlined">task_alt</span> সম্পন্ন হয়েছে';

                    const sidebarIcon = document.querySelector(`#lesson-btn-${currentLessonId} .status-icon`);
                    if (sidebarIcon) {
                        sidebarIcon.innerHTML = 'check_circle';
                        sidebarIcon.classList.add('text-emerald-500', 'material-symbols-outlined');
                    }
                    document.getElementById(`lesson-btn-${currentLessonId}`).setAttribute('data-completed', 'true');
                }
            } catch (err) { console.error(err); }
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (currentLessonId && document.getElementById(`lesson-btn-${currentLessonId}`)) {
                const isCompleted = document.getElementById(`lesson-btn-${currentLessonId}`).getAttribute('data-completed') === 'true';
                if (isCompleted) {
                    const btn = document.getElementById('complete-btn');
                    btn.className = "btn-secondary !py-3 !px-8 !rounded-2xl !bg-emerald-500/10 !text-emerald-500 pointer-events-none";
                    btn.innerHTML = '<span class="material-symbols-outlined">task_alt</span> সম্পন্ন হয়েছে';
                }
            }
            // Intersection Observer
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => entry.isIntersecting && entry.target.classList.add('active'));
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        });
    </script>
</body>

</html>