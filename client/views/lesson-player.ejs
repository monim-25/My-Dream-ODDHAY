<!DOCTYPE html>
<html class="light" lang="bn">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>
        <%= course.title %> | ODDHAY
    </title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@300..900&family=Noto+Sans+Bengali:wght@300..900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Lexend", "Noto Sans Bengali", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', 'Noto Sans Bengali', sans-serif;
        }

        .video-container {
            aspect-ratio: 16/9;
        }

        .sidebar-scroll {
            height: calc(100vh - 200px);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#0d141b] dark:text-slate-100 min-h-screen">
    <!-- Navbar -->
    <header
        class="border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md px-6 py-4 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/courses"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <div>
                    <h1 class="text-xl font-bold truncate max-w-[300px] md:max-w-none">
                        <%= course.title %>
                    </h1>
                    <p class="text-xs text-slate-500">
                        <%= course.category %>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800"
                    onclick="document.documentElement.classList.toggle('dark')">
                    <span class="material-symbols-outlined block dark:hidden">dark_mode</span>
                    <span class="material-symbols-outlined hidden dark:block">light_mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-4 md:p-6 lg:p-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Side: Video Player & Tabs -->
            <div class="flex-1 space-y-6">
                <!-- Video Player Card / Guest Overlay -->
                <div class="bg-black rounded-3xl overflow-hidden shadow-2xl video-container relative group">
                    <% if (hasAccess) { %>
                        <iframe id="main-player" class="w-full h-full"
                            src="<%= course.lessons.length > 0 ? course.lessons[0].videoUrl : '' %>" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        <% if(course.lessons.length===0) { %>
                            <div
                                class="absolute inset-0 flex flex-col items-center justify-center text-white bg-slate-900">
                                <span class="material-symbols-outlined text-6xl mb-4">video_off</span>
                                <p class="font-bold">এই কন্টেন্টটি এখনো আপলোড করা হয়নি।</p>
                            </div>
                            <% } %>
                                <% } else { %>
                                    <!-- Lock Overlay -->
                                    <div class="absolute inset-0 z-10 flex items-center justify-center p-6 text-center">
                                        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-xl"></div>
                                        <div class="relative z-20 max-w-sm w-full">
                                            <div
                                                class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                                <span class="material-symbols-outlined text-3xl text-primary">
                                                    <%= trialExpired ? 'hourglass_disabled' : (subscriptionExpired
                                                        ? 'history' : 'lock' ) %>
                                                </span>
                                            </div>
                                            <h3 class="text-xl font-black text-white mb-2">
                                                <%= trialExpired ? 'ট্রায়াল শেষ হয়েছে' : (subscriptionExpired
                                                    ? 'সাবস্ক্রিপশন শেষ' : 'কোর্সটি লক করা আছে' ) %>
                                            </h3>
                                            <p class="text-slate-400 text-xs mb-8 leading-relaxed">
                                                <%= trialExpired
                                                    ? 'আপনার ফ্রি ট্রায়াল শেষ। পুরো কোর্সটি দেখতে এখনই সাবস্ক্রিপশন করুন।'
                                                    : (subscriptionExpired
                                                    ? 'আপনার সাবস্ক্রিপশন পিরিয়ড শেষ হয়েছে। নতুন প্ল্যান কিনুন।'
                                                    : 'এই প্রিমিয়াম কোর্সটি দেখতে নিচের যেকোনো একটি প্ল্যান সিলেক্ট করুন।'
                                                    ) %>
                                            </p>

                                            <div class="mt-8">
                                                <a href="/checkout/<%= course._id %>"
                                                    class="w-full block text-center py-4 bg-primary text-white rounded-2xl font-black shadow-xl shadow-primary/30 hover:scale-[1.02] transition-all">
                                                    প্ল্যান কিনুন
                                                </a>
                                            </div>

                                            <% if (course.accessType==='trial' && !trialExpired && !subscriptionExpired)
                                                { %>
                                                <form action="/enroll-trial/<%= course._id %>" method="POST"
                                                    class="mt-3">
                                                    <button type="submit"
                                                        class="w-full py-3 bg-white/10 text-white border border-white/20 rounded-2xl font-bold hover:bg-white/20 transition-all text-xs">
                                                        <%= course.trialPeriod %> দিনের ফ্রি ট্রায়াল শুরু করুন
                                                    </button>
                                                </form>
                                                <% } %>
                                        </div>
                                    </div>
                                    <img src="<%= course.thumbnail || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&q=80&w=800' %>"
                                        class="w-full h-full object-cover">
                                    <% } %>
                </div>

                <!-- Course Meta & Tabs -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-3xl p-8 border border-slate-200 dark:border-slate-800 shadow-sm">
                    <div class="flex border-b border-slate-100 dark:border-slate-800 mb-6">
                        <button class="px-6 py-3 border-b-2 border-primary text-primary font-bold text-sm">বিস্তারিত
                            বিবরণ</button>
                        <button
                            class="px-6 py-3 text-slate-400 font-medium text-sm hover:text-slate-600 transition-colors">লেকচার
                            নোটস</button>
                    </div>

                    <div id="details-tab">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h2 id="current-lesson-title" class="text-2xl font-black">
                                <%= course.lessons.length> 0 ? course.lessons[0].title : 'স্বাগতম!' %>
                            </h2>
                            <button id="complete-btn" onclick="markComplete()"
                                class="flex items-center gap-2 px-6 py-2 bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 hover:scale-105 transition-all">
                                <span class="material-symbols-outlined text-sm">check_circle</span> শেষ হয়েছে
                            </button>
                        </div>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
                            <%= course.description %>
                        </p>
                    </div>

                    <div id="notes-tab" class="hidden mt-8 space-y-3">
                        <h3 class="font-bold mb-4">রিসোর্স এবং নোটস</h3>
                        <% if (user) { %>
                            <% course.notes.forEach(note=> { %>
                                <div
                                    class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-red-500">picture_as_pdf</span>
                                        <span class="text-sm font-medium">
                                            <%= note.title %>
                                        </span>
                                    </div>
                                    <a href="<%= note.fileUrl %>" target="_blank"
                                        class="px-4 py-2 bg-white dark:bg-slate-700 text-primary text-xs font-bold rounded-lg shadow-sm">ডাউনলোড</a>
                                </div>
                                <% }); %>
                                    <% if(course.notes.length===0) { %>
                                        <p class="text-slate-400 text-sm italic">কোনো পিডিএফ নোট পাওয়া যায়নি।</p>
                                        <% } %>
                                            <% } else { %>
                                                <div
                                                    class="p-8 text-center bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700">
                                                    <span
                                                        class="material-symbols-outlined text-slate-300 text-4xl mb-3">lock</span>
                                                    <p class="text-sm font-medium text-slate-500">নোটস এবং রিসোর্স
                                                        ডাউনলোড করতে লগইন করুন।</p>
                                                </div>
                                                <% } %>
                    </div>
                </div>

                <!-- Similar Courses -->
                <div class="mt-12">
                    <h3 class="text-xl font-bold mb-6">এই ক্যাটাগরির আরও কোর্স</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <% if (locals.similarCourses && similarCourses.length> 0) { %>
                            <% similarCourses.forEach(simCourse=> { %>
                                <div
                                    class="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-800 flex gap-4 hover:shadow-lg transition-all group">
                                    <div class="w-32 h-20 rounded-xl overflow-hidden shrink-0">
                                        <img src="<%= simCourse.thumbnail || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&q=80&w=800' %>"
                                            class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1 py-1">
                                        <h4
                                            class="font-bold text-sm line-clamp-1 mb-2 group-hover:text-primary transition-colors">
                                            <%= simCourse.title %>
                                        </h4>
                                        <a href="/course-details/<%= simCourse._id %>"
                                            class="text-primary text-xs font-bold flex items-center gap-1 hover:underline">দেখুন
                                            <span class="material-symbols-outlined text-[10px]">arrow_forward</span></a>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p class="text-slate-500 italic text-sm">অন্যান্য কোনো কোর্স পাওয়া যায়নি।</p>
                                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Right Side: Playlist -->
            <aside class="w-full lg:w-[400px] shrink-0">
                <div
                    class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col h-full sticky top-28">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800">
                        <h3 class="font-black flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">play_lesson</span>
                            কোর্স কন্টেন্ট (<%= course.lessons.length %> টি লেসন)
                        </h3>
                    </div>
                    <div class="sidebar-scroll overflow-y-auto p-2">
                        <% if (user) { %>
                            <% course.lessons.forEach((lesson, index)=> { %>
                                <% const isCompleted=user.completedLessons &&
                                    user.completedLessons.includes(lesson._id.toString()); %>
                                    <button id="lesson-btn-<%= lesson._id %>" data-completed="<%= isCompleted %>"
                                        onclick="changeVideo('<%= lesson.videoUrl %>', '<%= lesson.title %>', '<%= lesson._id %>')"
                                        class="w-full flex items-start gap-4 p-4 rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left mb-1 group <%= index === 0 ? 'bg-primary/5 border border-primary/20' : '' %>">
                                        <div
                                            class="size-8 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xs font-bold shrink-0 text-slate-500 group-hover:bg-primary group-hover:text-white">
                                            <span
                                                class="text-sm status-icon <%= isCompleted ? 'material-symbols-outlined text-emerald-500' : '' %>">
                                                <%= isCompleted ? 'check_circle' : (index + 1) %>
                                            </span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-bold truncate leading-tight mb-1">
                                                <%= lesson.title %>
                                            </p>
                                            <div class="flex items-center gap-2 text-[10px] text-slate-400">
                                                <span class="material-symbols-outlined text-xs">schedule</span>
                                                <%= lesson.duration || '00:00' %>
                                            </div>
                                        </div>
                                    </button>
                                    <% }); %>
                                        <% } else { %>
                                            <% course.lessons.forEach((lesson, index)=> { %>
                                                <div
                                                    class="w-full flex items-start gap-4 p-4 rounded-2xl opacity-60 grayscale-[0.5] mb-1">
                                                    <div
                                                        class="size-8 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xs font-bold shrink-0 text-slate-400">
                                                        <span class="material-symbols-outlined text-sm">lock</span>
                                                    </div>
                                                    <div class="flex-1">
                                                        <p class="text-sm font-bold truncate leading-tight mb-1">
                                                            <%= lesson.title %>
                                                        </p>
                                                        <div class="flex items-center gap-2 text-[10px] text-slate-400">
                                                            <span
                                                                class="material-symbols-outlined text-xs">schedule</span>
                                                            <%= lesson.duration || '00:00' %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% }); %>
                                                    <% } %>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script>
        let currentLessonId = '<%= course.lessons.length > 0 ? course.lessons[0]._id : "" %>';

        function changeVideo(url, title, id) {
            document.getElementById('main-player').src = url;
            document.getElementById('current-lesson-title').innerText = title;
            currentLessonId = id;

            // Reset button based on completion status (check local updated UI or fetch status if needed, but for simplicity reset to incomplete unless we track state in JS ref)
            // For better UX, we should check if it's already completed in the user object passed to view.
            // But since page doesn't reload, we can just reset style to default "Mark Complete" state, 
            // unless we want to be fancy. For now, let's just reset it.
            const btn = document.getElementById('complete-btn');
            // Check if this new lesson is completed
            const isCompleted = document.getElementById(`lesson-btn-${id}`).getAttribute('data-completed') === 'true';

            if (isCompleted) {
                btn.className = "flex items-center gap-2 px-6 py-2 bg-slate-100 text-emerald-600 rounded-xl font-bold text-sm shadow-sm transition-all pointer-events-none";
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">verified</span> কমপ্লিটেড!';
            } else {
                btn.className = "flex items-center gap-2 px-6 py-2 bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 hover:scale-105 transition-all";
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">check_circle</span> শেষ হয়েছে';
                btn.style.pointerEvents = 'auto';
            }

            // Highlight active button
            const buttons = document.querySelectorAll('button[id^="lesson-btn-"]');
            buttons.forEach(btn => {
                btn.classList.remove('bg-primary/5', 'border', 'border-primary/20');
            });
            const activeBtn = document.getElementById(`lesson-btn-${id}`);
            if (activeBtn) activeBtn.classList.add('bg-primary/5', 'border', 'border-primary/20');
        }

        async function markComplete() {
            const btn = document.getElementById('complete-btn');

            try {
                const res = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lessonId: currentLessonId })
                });

                if (res.ok) {
                    btn.className = "flex items-center gap-2 px-6 py-2 bg-slate-100 text-emerald-600 rounded-xl font-bold text-sm shadow-sm transition-all";
                    btn.innerHTML = '<span class="material-symbols-outlined text-sm">verified</span> কমপ্লিটেড!';

                    // Update sidebar icon
                    const sidebarIcon = document.querySelector(`#lesson-btn-${currentLessonId} .status-icon`);
                    if (sidebarIcon) {
                        sidebarIcon.innerHTML = 'check_circle';
                        sidebarIcon.classList.add('text-emerald-500');
                    }
                    // Update data attribute
                    document.getElementById(`lesson-btn-${currentLessonId}`).setAttribute('data-completed', 'true');
                }
            } catch (err) {
                console.error("Progress record failed", err);
            }
        }

        // Initialize button state for the first lesson on load
        window.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById(`lesson-btn-${currentLessonId}`)) {
                const isCompleted = document.getElementById(`lesson-btn-${currentLessonId}`).getAttribute('data-completed') === 'true';
                const btn = document.getElementById('complete-btn');

                if (isCompleted && btn) {
                    btn.className = "flex items-center gap-2 px-6 py-2 bg-slate-100 text-emerald-600 rounded-xl font-bold text-sm shadow-sm transition-all pointer-events-none";
                    btn.innerHTML = '<span class="material-symbols-outlined text-sm">verified</span> কমপ্লিটেড!';
                }
            }
        });
    </script>
</body>

</html>