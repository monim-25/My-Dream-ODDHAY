<!DOCTYPE html>
<html class="light" lang="bn">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>প্যারেন্ট পোর্টাল | অধ্যায়</title>
    <%- include('partials/head') %>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            .sidebar-item-active {
                background: rgba(19, 127, 236, 0.1);
                color: #137fec;
            }

            .bottom-nav-active {
                color: #137fec;
            }

            .glass-header {
                backdrop-filter: blur(12px);
                background: rgba(255, 255, 255, 0.8);
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }

            .dark .glass-header {
                background: rgba(15, 23, 42, 0.8);
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .animate-pop {
                animation: pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            @keyframes pop {
                from {
                    opacity: 0;
                    transform: scale(0.95) translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            /* Hide scrollbar but allow scrolling */
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }

            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        </style>
</head>

<body class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <!-- Top Header -->
    <header class="fixed top-0 left-0 right-0 z-[100] glass-header px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <!-- Hamburger/Menu -->
            <button onclick="toggleSidebar()"
                class="lg:hidden size-11 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500">
                <span class="material-symbols-outlined">menu</span>
            </button>
            <a href="/" class="flex items-center gap-2 group">
                <div class="text-primary group-hover:rotate-12 transition-transform duration-300">
                    <svg class="size-8" fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4H17.3334V17.3334H30.6666V30.6666H44V44H4V4Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-black tracking-tighter">ODDHAY</h1>
            </a>
        </div>

        <div class="flex items-center gap-3">
            <!-- Theme Toggle -->
            <button onclick="document.documentElement.classList.toggle('dark')"
                class="size-11 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 flex items-center justify-center">
                <span class="material-symbols-outlined dark:hidden">dark_mode</span>
                <span class="material-symbols-outlined hidden dark:block text-amber-400">light_mode</span>
            </button>
            <!-- Profile with Dropdown -->
            <div class="relative">
                <button id="profile-btn"
                    class="size-11 rounded-xl bg-primary text-white flex items-center justify-center font-black shadow-lg shadow-primary/20 ring-2 ring-white dark:ring-slate-800">
                    <%= user ? user.name[0] : 'P' %>
                </button>
                <!-- Dropdown -->
                <div id="profile-dropdown"
                    class="hidden absolute right-0 mt-3 w-64 bg-white dark:bg-slate-900 rounded-[1.5rem] shadow-2xl border border-slate-100 dark:border-slate-800 py-4 z-[200] animate-pop">
                    <div class="px-6 py-3 border-bottom border-slate-50 dark:border-slate-800 mb-2">
                        <p class="text-xs font-black text-slate-400 uppercase leading-none mb-1">প্রোফাইল</p>
                        <p class="text-sm font-black truncate">
                            <%= user ? user.name : 'অভিভাবক' %>
                        </p>
                    </div>
                    <a href="/profile"
                        class="flex items-center gap-3 px-6 py-3 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-primary transition-all">
                        <span class="material-symbols-outlined text-xl">account_circle</span> প্রোফাইল
                    </a>
                    <a href="/settings"
                        class="flex items-center gap-3 px-6 py-3 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-primary transition-all">
                        <span class="material-symbols-outlined text-xl">settings</span> সেটিংস
                    </a>

                    <% if(confirmedChildren && confirmedChildren.length> 0) { %>
                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2 mx-6"></div>
                        <p class="px-6 py-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">সন্তান
                            পরিবর্তন</p>
                        <div class="max-h-32 overflow-y-auto no-scrollbar">
                            <% confirmedChildren.forEach((child, idx)=> { %>
                                <button onclick="switchChild(<%= idx %>)"
                                    class="w-full flex items-center gap-3 px-6 py-3 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-primary transition-all">
                                    <span class="size-2 rounded-full bg-emerald-500"></span>
                                    <%= child.name %>
                                </button>
                                <% }) %>
                        </div>
                        <% } %>

                            <div class="h-px bg-slate-100 dark:bg-slate-800 my-2 mx-6"></div>
                            <a href="/logout"
                                class="flex items-center gap-3 px-6 py-3 text-sm font-black text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                                <span class="material-symbols-outlined text-xl">logout</span> লগআউট
                            </a>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 pt-20 pb-20 md:pb-0">
        <!-- Vertical Sidebar (Desktop) -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 p-8 flex flex-col z-[4000] -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300">
            <div class="flex items-center justify-between lg:hidden mb-10">
                <span class="text-xl font-black italic">মেনু</span>
                <button onclick="toggleSidebar()" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <nav class="space-y-3 flex-1">
                <a href="/parent/dashboard"
                    class="flex items-center gap-3 px-6 py-4 rounded-2xl sidebar-item-active font-black">
                    <span class="material-symbols-outlined">family_restroom</span> মনিটর প্যানেল
                </a>
                <a href="/messages"
                    class="flex items-center gap-3 px-6 py-4 rounded-2xl text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold transition-all">
                    <span class="material-symbols-outlined">mail</span> মেসেজ প্যানেল
                </a>
                <a href="/notifications"
                    class="flex items-center gap-3 px-6 py-4 rounded-2xl text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold transition-all">
                    <span class="material-symbols-outlined">notifications</span> নোটিফিকেশন
                </a>
                <a href="/settings"
                    class="flex items-center gap-3 px-6 py-4 rounded-2xl text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 font-bold transition-all">
                    <span class="material-symbols-outlined">settings</span> সেটিংস
                </a>
            </nav>
            <div class="pt-6 border-t border-slate-100 dark:border-slate-800">
                <a href="/logout"
                    class="flex items-center gap-3 px-6 py-4 rounded-2xl text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 font-black">
                    <span class="material-symbols-outlined">logout</span> লগআউট
                </a>
            </div>
        </aside>

        <!-- Main Content Section -->
        <main class="flex-1 p-6 md:p-10 max-w-7xl mx-auto w-full">
            <div id="home-view" class="space-y-10">
                <% if(!confirmedChildren || confirmedChildren.length===0) { %>
                    <!-- Empty State / Welcome -->
                    <div class="flex flex-col items-center justify-center py-20 text-center animate-pop">
                        <div
                            class="size-40 bg-white dark:bg-slate-900 rounded-[3rem] shadow-2xl flex items-center justify-center mb-8 relative group">
                            <span
                                class="material-symbols-outlined text-8xl text-slate-200 group-hover:scale-110 group-hover:text-primary transition-all duration-500">family_restroom</span>
                            <div
                                class="absolute -bottom-2 -right-2 size-12 bg-primary rounded-2xl flex items-center justify-center text-white shadow-lg">
                                <span class="material-symbols-outlined">add</span>
                            </div>
                        </div>
                        <h2 class="text-3xl font-black mb-4 italic">স্বাগতম, <%= user ? user.name : '' %>!</h2>
                        <p class="text-slate-500 font-bold max-w-sm mb-10">আপনার সন্তানের পড়াশোনা মনিটর করতে তার অধ্যায়
                            (ODDHAY) একাউন্ট কানেক্ট করুন।</p>
                        <button onclick="document.getElementById('add-child-modal').classList.remove('hidden')"
                            class="px-12 h-16 bg-primary text-white rounded-[2rem] font-black text-lg shadow-2xl shadow-primary/30 hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                            সন্তান কানেক্ট করুন <span class="material-symbols-outlined">east</span>
                        </button>
                    </div>
                    <% } else { %>
                        <!-- Active Child Content -->
                        <div id="children-container">
                            <% confirmedChildren.forEach((child, cIdx)=> { %>
                                <div id="child-view-<%= cIdx %>"
                                    class="child-view <%= cIdx === 0 ? '' : 'hidden' %> space-y-10">
                                    <div
                                        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <div class="reveal">
                                            <p
                                                class="text-[10px] font-black text-primary uppercase tracking-[0.3em] mb-1">
                                                মনিটর করা হচ্ছে</p>
                                            <h2 class="text-4xl font-black italic">
                                                <%= child.name %>
                                            </h2>
                                        </div>
                                        <button
                                            onclick="document.getElementById('add-child-modal').classList.remove('hidden')"
                                            class="px-6 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl font-black text-xs uppercase tracking-widest text-slate-500 hover:text-primary transition-all">
                                            + অন্য সন্তান যোগ
                                        </button>
                                    </div>

                                    <!-- Progress Overview Card -->
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div
                                            class="md:col-span-2 bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm relative overflow-hidden group">
                                            <div class="relative z-10 h-full flex flex-col justify-between">
                                                <h4 class="text-xl font-black mb-6 flex items-center gap-2">
                                                    <span
                                                        class="material-symbols-outlined text-primary">analytics</span>
                                                    পড়াশোনার সময় (সাপ্তাহিক)
                                                </h4>
                                                <div class="h-44">
                                                    <canvas id="chart-<%= cIdx %>"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="bg-gradient-to-br from-primary to-blue-700 p-8 rounded-[2.5rem] text-white flex flex-col justify-between relative overflow-hidden group">
                                            <span
                                                class="material-symbols-outlined absolute -top-10 -right-10 text-[180px] opacity-10 group-hover:rotate-12 transition-all duration-700">task_alt</span>
                                            <p class="text-xs font-bold opacity-80 uppercase tracking-widest">লেসন শেষ
                                            </p>
                                            <h3 class="text-6xl font-black mt-2">
                                                <%= (child.completedLessons || []).length %>
                                            </h3>
                                            <p
                                                class="text-[10px] font-black bg-white/20 px-3 py-1.5 rounded-full w-fit mt-4">
                                                আপ-টু-ডেট</p>
                                        </div>
                                        <div
                                            class="bg-gradient-to-br from-amber-400 to-orange-600 p-8 rounded-[2.5rem] text-white flex flex-col justify-between relative overflow-hidden group">
                                            <span
                                                class="material-symbols-outlined absolute -top-10 -right-10 text-[180px] opacity-10 group-hover:rotate-12 transition-all duration-700">auto_graph</span>
                                            <p class="text-xs font-bold opacity-80 uppercase tracking-widest">গড় ফলাফল
                                            </p>
                                            <h3 class="text-6xl font-black mt-2">
                                                <% let scoreSum=0; (child.quizResults || []).forEach(r=> scoreSum +=
                                                    (r.score/r.total));
                                                    let avg = (child.quizResults && child.quizResults.length > 0) ?
                                                    (scoreSum / child.quizResults.length * 100).toFixed(0) : 0;
                                                    %>
                                                    <%= avg %>%
                                            </h3>
                                            <p
                                                class="text-[10px] font-black bg-white/20 px-3 py-1.5 rounded-full w-fit mt-4">
                                                উন্নতি হচ্ছে</p>
                                        </div>
                                    </div>

                                    <!-- Results and Details -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                                        <div
                                            class="lg:col-span-2 bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm">
                                            <h3 class="text-xl font-black mb-8">সাম্প্রতিক পরীক্ষার ফলাফল</h3>
                                            <div class="space-y-4">
                                                <% if(child.quizResults && child.quizResults.length> 0) { %>
                                                    <% [...child.quizResults].reverse().slice(0, 4).forEach(res=> { %>
                                                        <div
                                                            class="flex items-center justify-between p-5 bg-slate-50 dark:bg-slate-800/40 rounded-2xl border border-slate-100 dark:border-slate-800 group hover:border-primary transition-all">
                                                            <div class="flex items-center gap-4">
                                                                <div
                                                                    class="size-12 rounded-xl bg-white dark:bg-slate-900 flex items-center justify-center font-black text-primary shadow-sm">
                                                                    <%= (res.score/res.total * 100).toFixed(0) %>%
                                                                </div>
                                                                <div>
                                                                    <h5 class="font-black text-sm">
                                                                        <%= res.quiz ? res.quiz.title : 'নমুনা কুইজ' %>
                                                                    </h5>
                                                                    <p
                                                                        class="text-[10px] font-bold text-slate-400 uppercase">
                                                                        <%= new
                                                                            Date(res.date).toLocaleDateString('bn-BD')
                                                                            %>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <p class="text-lg font-black text-primary">
                                                                    <%= res.score %>/<%= res.total %>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <p
                                                                    class="text-slate-400 font-bold italic text-center py-10">
                                                                    এখনো কোনো পরীক্ষা সম্পন্ন হয়নি।</p>
                                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="space-y-6">
                                            <div class="bg-primary/5 p-8 rounded-[2.5rem] border border-primary/10">
                                                <h4 class="text-lg font-black mb-4">মেন্টর টিপস</h4>
                                                <p class="text-xs font-bold text-slate-500 italic leading-relaxed">"<%=
                                                        child.name %> এর গণিত ও বিজ্ঞানে সময় বাড়ানো উচিত। তার সাম্প্রতিক
                                                        পারফরম্যান্স ভালো হচ্ছে।"</p>
                                            </div>
                                            <div
                                                class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm">
                                                <h4 class="text-lg font-black mb-6">এক নজরে পারফরম্যান্স</h4>
                                                <div class="space-y-4">
                                                    <% const subs={}; (child.quizResults || []).forEach(r=> {
                                                        const s = (r.quiz && r.quiz.course) ? r.quiz.course.subject :
                                                        'অন্যান্য';
                                                        if(!subs[s]) subs[s] = {c:0, s:0}; subs[s].c++; subs[s].s +=
                                                        (r.score/r.total);
                                                        }); %>
                                                        <% Object.keys(subs).forEach(s=> { let p = (subs[s].s /
                                                            subs[s].c * 100).toFixed(0); %>
                                                            <div class="space-y-1">
                                                                <div
                                                                    class="flex justify-between text-[10px] font-black text-slate-400 uppercase">
                                                                    <span>
                                                                        <%= s %>
                                                                    </span><span>
                                                                        <%= p %>%
                                                                    </span>
                                                                </div>
                                                                <div
                                                                    class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                                                    <div class="h-full bg-primary rounded-full"
                                                                        style="width: <%= p %>%"></div>
                                                                </div>
                                                            </div>
                                                            <% }) %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                        </div>
                        <% } %>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav
        class="fixed bottom-0 left-0 right-0 z-[100] h-20 glass-header flex items-center justify-around px-6 lg:hidden shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <button onclick="window.location.href='/parent/dashboard'"
            class="flex flex-col items-center gap-1 bottom-nav-active">
            <span class="material-symbols-outlined">home</span>
            <span class="text-[10px] font-black uppercase tracking-widest">হোম</span>
        </button>
        <button onclick="window.location.href='/messages'" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="material-symbols-outlined">forum</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">মেসেজ</span>
        </button>
        <button onclick="window.location.href='/notifications'" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="material-symbols-outlined">notifications</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">এলার্ট</span>
        </button>
    </nav>

    <!-- Modal: Add Child -->
    <div id="add-child-modal"
        class="hidden fixed inset-0 bg-slate-950/40 backdrop-blur-md z-[5000] flex items-center justify-center p-6">
        <div class="max-w-md w-full bg-white dark:bg-slate-900 rounded-[2.5rem] p-10 relative animate-pop">
            <button onclick="document.getElementById('add-child-modal').classList.add('hidden')"
                class="absolute top-8 right-8 text-slate-400 hover:text-red-500 transition-all">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h3 class="text-2xl font-black mb-2 italic">সন্তান কানেক্ট করুন</h3>
            <p class="text-slate-500 font-bold text-sm mb-10">সন্তানের অধ্যায় (ODDHAY) একাউন্টের ইমেইল বা ফোন নম্বর দিন।
            </p>
            <form action="/parent/add-child" method="POST" class="space-y-6">
                <div>
                    <label
                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-2">আইডেন্টিফায়ার</label>
                    <input type="text" name="childIdentifier" placeholder="ইমেইল বা ফোন নম্বর"
                        class="w-full h-15 rounded-2xl bg-slate-50 dark:bg-slate-950 border-none px-6 font-black italic focus:ring-4 focus:ring-primary/10 transition-all shadow-inner"
                        required />
                </div>
                <button type="submit"
                    class="w-full h-16 bg-primary text-white rounded-2xl font-black text-lg shadow-2xl shadow-primary/30 hover:scale-105 active:scale-95 transition-all">রিকোয়েস্ট
                    পাঠান</button>
            </form>
        </div>
    </div>

    <script>
        // Tab switching for children
        function switchChild(idx) {
            document.querySelectorAll('.child-view').forEach(v => v.classList.add('hidden'));
            const activeView = document.getElementById('child-view-' + idx);
            if (activeView) activeView.classList.remove('hidden');

            // Highlight in dropdown
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileDropdown) profileDropdown.classList.add('hidden');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Dropdown Toggles
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');

            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', () => {
                    profileDropdown.classList.add('hidden');
                });
            }

            // Charts initialization
            <% if (confirmedChildren) { %>
                <% confirmedChildren.forEach((child, cIdx) => { %>
                    const ctx<%= cIdx %> = document.getElementById('chart-<%= cIdx %>').getContext('2d');
                new Chart(ctx <%= cIdx %>, {
                    type: 'line',
                    data: {
                        labels: ['শনি', 'রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র'],
                        datasets: [{
                            data: [2, 4.5, 3.8, 5.2, 4.0, 6.5, 5.0],
                            borderColor: '#137fec',
                            backgroundColor: 'rgba(19, 127, 236, 0.05)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 5,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { display: false, beginAtZero: true },
                            x: { display: true, grid: { display: false }, ticks: { font: { weight: 'bold', size: 10 }, color: '#94a3b8' } }
                        }
                    }
                });
                <% }) %>
            <% } %>
        });
    </script>
</body>

</html>