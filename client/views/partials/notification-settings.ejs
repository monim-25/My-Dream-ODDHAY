<!-- Push Notification Settings Component -->
<div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-indigo-100 dark:bg-indigo-500/20 flex items-center justify-center">
                <span
                    class="material-symbols-outlined text-indigo-600 dark:text-indigo-400 text-2xl">notifications</span>
            </div>
            <div>
                <h3 class="font-black text-slate-900 dark:text-white">পুশ নোটিফিকেশন</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">গুরুত্বপূর্ণ আপডেট পান</p>
            </div>
        </div>
        <button id="notification-toggle" onclick="toggleNotifications()"
            class="relative inline-flex h-8 w-14 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 bg-slate-200 dark:bg-slate-700">
            <span id="notification-toggle-dot"
                class="inline-block h-6 w-6 transform rounded-full bg-white shadow-lg transition-transform translate-x-1"></span>
        </button>
    </div>

    <div id="notification-status" class="text-sm text-slate-600 dark:text-slate-400">
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">info</span>
            <span>চেক করা হচ্ছে...</span>
        </div>
    </div>

    <!-- Test Notification Button (when enabled) -->
    <div id="test-notification-btn" class="hidden mt-4">
        <button onclick="testNotificationFromDashboard()"
            class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-900 dark:text-white rounded-xl font-bold text-sm transition-all">
            <span class="material-symbols-outlined text-sm align-middle">science</span>
            টেস্ট নোটিফিকেশন পাঠান
        </button>
    </div>
</div>

<script>
    // Initialize push notification manager
    let notificationEnabled = false;

    async function checkNotificationStatus() {
        if (!window.pushManager) {
            updateNotificationUI(false, 'আপনার ব্রাউজার নোটিফিকেশন সাপোর্ট করে না');
            return;
        }

        const isSubscribed = await window.pushManager.isSubscribed();
        notificationEnabled = isSubscribed;

        if (isSubscribed) {
            updateNotificationUI(true, '✅ নোটিফিকেশন চালু আছে');
            document.getElementById('test-notification-btn').classList.remove('hidden');
        } else {
            updateNotificationUI(false, 'নোটিফিকেশন বন্ধ আছে');
            document.getElementById('test-notification-btn').classList.add('hidden');
        }
    }

    async function toggleNotifications() {
        if (!window.pushManager) {
            alert('আপনার ব্রাউজার পুশ নোটিফিকেশন সাপোর্ট করে না');
            return;
        }

        const toggle = document.getElementById('notification-toggle');
        toggle.disabled = true;

        try {
            if (notificationEnabled) {
                // Unsubscribe
                await window.pushManager.unsubscribe();
                notificationEnabled = false;
                updateNotificationUI(false, 'নোটিফিকেশন বন্ধ করা হয়েছে');
                document.getElementById('test-notification-btn').classList.add('hidden');
            } else {
                // Subscribe
                const success = await window.pushManager.requestPermission();
                if (success) {
                    notificationEnabled = true;
                    updateNotificationUI(true, '✅ নোটিফিকেশন চালু করা হয়েছে');
                    document.getElementById('test-notification-btn').classList.remove('hidden');
                } else {
                    updateNotificationUI(false, 'নোটিফিকেশন অনুমতি প্রত্যাখ্যান করা হয়েছে');
                }
            }
        } catch (error) {
            console.error('Toggle error:', error);
            updateNotificationUI(notificationEnabled, 'একটি ত্রুটি ঘটেছে');
        } finally {
            toggle.disabled = false;
        }
    }

    function updateNotificationUI(enabled, message) {
        const toggle = document.getElementById('notification-toggle');
        const dot = document.getElementById('notification-toggle-dot');
        const status = document.getElementById('notification-status');

        if (enabled) {
            toggle.classList.remove('bg-slate-200', 'dark:bg-slate-700');
            toggle.classList.add('bg-primary');
            dot.classList.remove('translate-x-1');
            dot.classList.add('translate-x-7');
        } else {
            toggle.classList.add('bg-slate-200', 'dark:bg-slate-700');
            toggle.classList.remove('bg-primary');
            dot.classList.add('translate-x-1');
            dot.classList.remove('translate-x-7');
        }

        status.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">${enabled ? 'check_circle' : 'info'}</span>
                <span>${message}</span>
            </div>
        `;
    }

    async function testNotificationFromDashboard() {
        try {
            const response = await fetch('/api/push/test', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                updateNotificationUI(true, '✅ টেস্ট নোটিফিকেশন পাঠানো হয়েছে!');
            } else {
                updateNotificationUI(true, '❌ টেস্ট ব্যর্থ হয়েছে');
            }
        } catch (error) {
            console.error('Test error:', error);
        }
    }

    // Check status on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkNotificationStatus);
    } else {
        checkNotificationStatus();
    }
</script>