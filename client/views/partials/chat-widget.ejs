<!-- Live Chat Widget - Socket.io powered -->
<div id="live-chat-widget" class="fixed bottom-8 right-8 z-[1000]">
    <!-- Toggle Button -->
    <button onclick="toggleChat()"
        class="size-16 rounded-full bg-primary text-white shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all relative">
        <span id="chat-icon" class="material-symbols-outlined text-3xl">chat</span>
        <span id="chat-close" class="material-symbols-outlined text-3xl hidden">close</span>
        <!-- Unread badge -->
        <div id="chat-badge"
            class="absolute -top-1 -right-1 size-5 bg-red-500 rounded-full border-2 border-white text-white text-[10px] font-black flex items-center justify-center hidden">
            0
        </div>
    </button>

    <!-- Chat Box -->
    <div id="chat-box"
        class="absolute bottom-20 right-0 w-80 md:w-96 bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-slate-100 dark:border-slate-800 flex flex-col overflow-hidden transition-all duration-300 scale-0 opacity-0 origin-bottom-right"
        style="height: 480px;">

        <!-- Header -->
        <div class="p-5 bg-primary text-white flex items-center justify-between flex-shrink-0">
            <div>
                <h4 class="font-black text-base">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h4>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <div class="size-2 bg-emerald-400 rounded-full animate-pulse"></div>
                    <p class="text-xs font-bold opacity-90">‡¶≤‡¶æ‡¶á‡¶≠</p>
                </div>
            </div>
            <a href="/messages"
                class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full font-bold transition-colors">
                ‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‚Üí
            </a>
        </div>

        <!-- Messages Area -->
        <div id="widget-messages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-slate-50 dark:bg-slate-900/50">
            <div class="flex gap-2">
                <div class="size-7 rounded-full bg-primary/10 text-primary flex items-center justify-center shrink-0">
                    <span class="material-symbols-outlined text-sm">support_agent</span>
                </div>
                <div
                    class="p-3 rounded-2xl rounded-tl-sm bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 max-w-[80%]">
                    <p class="text-xs font-bold leading-relaxed">‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ! ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?</p>
                </div>
            </div>
        </div>

        <!-- Typing indicator -->
        <div id="widget-typing" class="hidden px-4 pb-2">
            <div class="flex gap-2 items-center">
                <div class="size-7 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm text-primary">support_agent</span>
                </div>
                <div class="px-3 py-2 bg-white dark:bg-slate-800 rounded-xl text-slate-400 text-lg">
                    <span style="animation: blink 1.4s infinite; display:inline-block">‚Ä¢</span>
                    <span style="animation: blink 1.4s infinite 0.2s; display:inline-block">‚Ä¢</span>
                    <span style="animation: blink 1.4s infinite 0.4s; display:inline-block">‚Ä¢</span>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex-shrink-0">
            <form id="widget-form" class="flex gap-2">
                <input type="text" id="widget-input" placeholder="‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                    class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                    maxlength="500">
                <button type="submit"
                    class="size-10 rounded-xl bg-primary text-white flex items-center justify-center hover:opacity-90 active:scale-95 transition-all flex-shrink-0">
                    <span class="material-symbols-outlined text-xl">send</span>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    @keyframes blink {

        0%,
        80%,
        100% {
            opacity: 0;
        }

        40% {
            opacity: 1;
        }
    }
</style>

<script>
    // Widget state
    let widgetSocket = null;
    let widgetOpen = false;
    let widgetUnread = 0;

    function toggleChat() {
        const box = document.getElementById('chat-box');
        const icon = document.getElementById('chat-icon');
        const closeIcon = document.getElementById('chat-close');

        widgetOpen = !widgetOpen;

        if (widgetOpen) {
            box.classList.remove('scale-0', 'opacity-0');
            box.classList.add('scale-100', 'opacity-100');
            icon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            // Reset unread
            widgetUnread = 0;
            updateBadge();
            // Scroll to bottom
            const msgs = document.getElementById('widget-messages');
            msgs.scrollTop = msgs.scrollHeight;
            // Init socket if not connected
            if (!widgetSocket) initWidgetSocket();
        } else {
            box.classList.add('scale-0', 'opacity-0');
            box.classList.remove('scale-100', 'opacity-100');
            icon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }
    }

    function initWidgetSocket() {
        // Only init if socket.io is available and user is logged in
        if (typeof io === 'undefined') return;

        const userEl = document.querySelector('[data-user-id]');
        const userId = userEl?.dataset.userId;
        const userName = userEl?.dataset.userName;
        const userRole = userEl?.dataset.userRole;

        if (!userId) return;

        widgetSocket = io({ transports: ['websocket', 'polling'] });

        widgetSocket.on('connect', () => {
            widgetSocket.emit('user:join', { userId, name: userName, role: userRole });
        });

        widgetSocket.on('message:new', (msg) => {
            if (msg.room === 'global' && msg.sender !== userId) {
                appendWidgetMessage(msg.senderName, msg.text, false);
                if (!widgetOpen) {
                    widgetUnread++;
                    updateBadge();
                }
            }
        });

        widgetSocket.on('typing:show', ({ name }) => {
            document.getElementById('widget-typing').classList.remove('hidden');
        });
        widgetSocket.on('typing:hide', () => {
            document.getElementById('widget-typing').classList.add('hidden');
        });
    }

    document.getElementById('widget-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('widget-input');
        const text = input.value.trim();
        if (!text) return;

        // Show own message immediately
        appendWidgetMessage('‡¶Ü‡¶™‡¶®‡¶ø', text, true);
        input.value = '';

        // Send via socket if connected
        if (widgetSocket?.connected) {
            widgetSocket.emit('message:send', { room: 'global', text });
        }
    });

    function appendWidgetMessage(senderName, text, isMe) {
        const container = document.getElementById('widget-messages');
        const div = document.createElement('div');
        div.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : ''}`;
        div.innerHTML = `
            <div class="size-7 rounded-full ${isMe ? 'bg-slate-200 dark:bg-slate-700' : 'bg-primary/10 text-primary'} flex items-center justify-center shrink-0 text-xs font-black">
                ${isMe ? 'üë§' : (senderName ? senderName[0].toUpperCase() : '?')}
            </div>
            <div class="p-3 rounded-2xl text-xs font-bold leading-relaxed max-w-[80%]
                ${isMe ? 'bg-primary text-white rounded-tr-sm' : 'bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 rounded-tl-sm'}">
                ${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </div>
        `;
        const typingEl = document.getElementById('widget-typing');
        container.insertBefore(div, typingEl);
        container.scrollTop = container.scrollHeight;
    }

    function updateBadge() {
        const badge = document.getElementById('chat-badge');
        if (widgetUnread > 0) {
            badge.classList.remove('hidden');
            badge.textContent = widgetUnread > 9 ? '‡ßØ+' : widgetUnread;
        } else {
            badge.classList.add('hidden');
        }
    }
</script>