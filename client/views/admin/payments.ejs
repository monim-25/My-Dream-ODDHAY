<!DOCTYPE html>
<html class="light" lang="bn">

<head>
    <title>পেমেন্ট ম্যানেজমেন্ট | Admin</title>
    <%- include('../partials/head') %>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-black flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">payments</span>
                    পেমেন্ট ম্যানেজমেন্ট
                </h1>
                <p class="text-slate-400 text-sm font-bold mt-1">সকল পেমেন্ট রিকোয়েস্ট দেখুন এবং অনুমোদন করুন</p>
            </div>
            <a href="/admin" class="btn-secondary !py-2 !px-4 !text-xs">← অ্যাডমিন প্যানেল</a>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card-smart !p-5 text-center">
                <div class="text-3xl font-black text-amber-500">
                    <%= stats.pending %>
                </div>
                <div class="text-xs font-bold text-slate-400 mt-1">অপেক্ষমান</div>
            </div>
            <div class="card-smart !p-5 text-center">
                <div class="text-3xl font-black text-emerald-500">
                    <%= stats.approved %>
                </div>
                <div class="text-xs font-bold text-slate-400 mt-1">অনুমোদিত</div>
            </div>
            <div class="card-smart !p-5 text-center">
                <div class="text-3xl font-black text-red-500">
                    <%= stats.rejected %>
                </div>
                <div class="text-xs font-bold text-slate-400 mt-1">বাতিল</div>
            </div>
            <div class="card-smart !p-5 text-center">
                <div class="text-3xl font-black text-primary">৳<%= stats.totalRevenue.toLocaleString() %>
                </div>
                <div class="text-xs font-bold text-slate-400 mt-1">মোট আয়</div>
            </div>
        </div>

        <!-- Filter tabs -->
        <div class="flex gap-2 mb-6">
            <a href="?status=pending"
                class="px-4 py-2 rounded-xl text-xs font-black transition-all <%= filter === 'pending' ? 'bg-amber-500 text-white' : 'bg-white dark:bg-slate-800 text-slate-400 hover:text-slate-600' %>">
                ⏳ অপেক্ষমান (<%= stats.pending %>)
            </a>
            <a href="?status=approved"
                class="px-4 py-2 rounded-xl text-xs font-black transition-all <%= filter === 'approved' ? 'bg-emerald-500 text-white' : 'bg-white dark:bg-slate-800 text-slate-400 hover:text-slate-600' %>">
                ✅ অনুমোদিত
            </a>
            <a href="?status=rejected"
                class="px-4 py-2 rounded-xl text-xs font-black transition-all <%= filter === 'rejected' ? 'bg-red-500 text-white' : 'bg-white dark:bg-slate-800 text-slate-400 hover:text-slate-600' %>">
                ❌ বাতিল
            </a>
            <a href="?status=all"
                class="px-4 py-2 rounded-xl text-xs font-black transition-all <%= filter === 'all' ? 'bg-primary text-white' : 'bg-white dark:bg-slate-800 text-slate-400 hover:text-slate-600' %>">
                সব দেখুন
            </a>
        </div>

        <!-- Payments Table -->
        <div class="card-smart !p-0 overflow-hidden">
            <% if (payments.length===0) { %>
                <div class="text-center py-20">
                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-4 block">receipt_long</span>
                    <p class="font-bold text-slate-400">কোনো পেমেন্ট নেই</p>
                </div>
                <% } else { %>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr
                                    class="border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        ছাত্র</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        কোর্স</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        পরিমাণ</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        মেথড / TrxID</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        তারিখ</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        স্ট্যাটাস</th>
                                    <th
                                        class="text-left px-6 py-4 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        অ্যাকশন</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                <% payments.forEach(function(p) { %>
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div
                                                    class="size-9 rounded-full bg-primary/10 text-primary flex items-center justify-center font-black text-sm flex-shrink-0">
                                                    <%= p.user?.name ? p.user.name[0].toUpperCase() : '?' %>
                                                </div>
                                                <div>
                                                    <div class="font-black text-sm">
                                                        <%= p.user?.name || 'Unknown' %>
                                                    </div>
                                                    <div class="text-xs text-slate-400">
                                                        <%= p.phoneNumber %>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-bold text-sm max-w-[150px] truncate">
                                                <%= p.course?.title || 'N/A' %>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="font-black text-primary">৳<%= p.amount %></span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div
                                                class="font-bold text-sm capitalize <%= p.paymentMethod === 'bkash' ? 'text-pink-600' : 'text-orange-600' %>">
                                                <%= p.paymentMethod %>
                                            </div>
                                            <div class="text-xs font-mono text-slate-400 mt-0.5">
                                                <%= p.transactionId %>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-xs font-bold text-slate-400">
                                                <%= new Date(p.createdAt).toLocaleDateString('bn-BD') %>
                                            </div>
                                            <div class="text-xs text-slate-300">
                                                <%= new Date(p.createdAt).toLocaleTimeString('bn-BD', {hour: '2-digit' ,
                                                    minute: '2-digit' }) %>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <% if (p.status==='pending' ) { %>
                                                <span
                                                    class="text-xs font-black bg-amber-100 dark:bg-amber-500/20 text-amber-600 px-3 py-1.5 rounded-full">⏳
                                                    অপেক্ষমান</span>
                                                <% } else if (p.status==='approved' ) { %>
                                                    <span
                                                        class="text-xs font-black bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 px-3 py-1.5 rounded-full">✅
                                                        অনুমোদিত</span>
                                                    <% } else { %>
                                                        <span
                                                            class="text-xs font-black bg-red-100 dark:bg-red-500/20 text-red-600 px-3 py-1.5 rounded-full">❌
                                                            বাতিল</span>
                                                        <% } %>
                                        </td>
                                        <td class="px-6 py-4">
                                            <% if (p.status==='pending' ) { %>
                                                <div class="flex gap-2">
                                                    <button onclick="reviewPayment('<%= p._id %>', 'approve')"
                                                        class="px-3 py-1.5 bg-emerald-500 text-white text-xs font-black rounded-xl hover:bg-emerald-600 transition-all">
                                                        ✓ অনুমোদন
                                                    </button>
                                                    <button onclick="reviewPayment('<%= p._id %>', 'reject')"
                                                        class="px-3 py-1.5 bg-red-500 text-white text-xs font-black rounded-xl hover:bg-red-600 transition-all">
                                                        ✗ বাতিল
                                                    </button>
                                                </div>
                                                <% } else { %>
                                                    <span class="text-xs text-slate-400 font-bold">
                                                        <%= p.reviewedAt ? new
                                                            Date(p.reviewedAt).toLocaleDateString('bn-BD') : '—' %>
                                                    </span>
                                                    <% } %>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <% } %>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-md w-full p-8">
            <h3 id="modal-title" class="text-xl font-black mb-2">পেমেন্ট অনুমোদন করুন</h3>
            <p id="modal-desc" class="text-sm text-slate-400 font-bold mb-6">এই পেমেন্ট অনুমোদন করলে ছাত্রটি কোর্সে
                এনরোল হবে।</p>

            <div class="mb-6">
                <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">নোট
                    (ঐচ্ছিক)</label>
                <textarea id="admin-note" rows="3" placeholder="কোনো মন্তব্য থাকলে লিখুন..."
                    class="w-full px-4 py-3 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
            </div>

            <div class="flex gap-3">
                <button id="confirm-btn" onclick="confirmReview()"
                    class="flex-1 h-12 bg-emerald-500 text-white font-black rounded-2xl hover:bg-emerald-600 transition-all">
                    নিশ্চিত করুন
                </button>
                <button onclick="closeModal()"
                    class="flex-1 h-12 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black rounded-2xl hover:bg-slate-200 transition-all">
                    বাতিল
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentPaymentId = null;
        let currentAction = null;

        function reviewPayment(paymentId, action) {
            currentPaymentId = paymentId;
            currentAction = action;

            const modal = document.getElementById('review-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const btn = document.getElementById('confirm-btn');

            if (action === 'approve') {
                title.textContent = '✅ পেমেন্ট অনুমোদন করুন';
                desc.textContent = 'এই পেমেন্ট অনুমোদন করলে ছাত্রটি কোর্সে এনরোল হবে।';
                btn.className = 'flex-1 h-12 bg-emerald-500 text-white font-black rounded-2xl hover:bg-emerald-600 transition-all';
            } else {
                title.textContent = '❌ পেমেন্ট বাতিল করুন';
                desc.textContent = 'এই পেমেন্ট বাতিল করলে ছাত্রটি কোর্সে এনরোল হবে না।';
                btn.className = 'flex-1 h-12 bg-red-500 text-white font-black rounded-2xl hover:bg-red-600 transition-all';
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('review-modal').classList.add('hidden');
            currentPaymentId = null;
            currentAction = null;
        }

        async function confirmReview() {
            if (!currentPaymentId || !currentAction) return;

            const note = document.getElementById('admin-note').value;
            const btn = document.getElementById('confirm-btn');
            btn.disabled = true;
            btn.textContent = 'প্রক্রিয়া হচ্ছে...';

            try {
                const res = await fetch(`/admin/payment/${currentPaymentId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: currentAction, adminNote: note })
                });
                const data = await res.json();

                if (data.success) {
                    closeModal();
                    window.location.reload();
                } else {
                    alert('সমস্যা হয়েছে: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'নিশ্চিত করুন';
                }
            } catch (err) {
                alert('নেটওয়ার্ক সমস্যা');
                btn.disabled = false;
            }
        }

        // Close modal on backdrop click
        document.getElementById('review-modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>

</html>